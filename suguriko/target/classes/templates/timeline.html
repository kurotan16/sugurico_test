<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>タイムライン | スグリコ</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
</head>
<body>
    <h1>みんなのログ（タイムライン）</h1>
    <p><a th:href="@{/}">マイページに戻る</a></p>
    <hr>

    <div th:if="${logPage.isEmpty()}">
        <p>まだ公開されたログはありません。</p>
    </div>

    <div th:unless="${logPage.isEmpty()}">
        <!-- ログ一覧 -->
        <ul>
            <li th:each="log : ${logPage.content}" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                <!-- 投稿者と日時の情報 -->
                <div>
                    <strong>投稿者: <span th:text="${log.user.username}"></span></strong>
                    <small th:text="${#temporals.format(log.createdAt, 'yyyy/MM/dd HH:mm')}" style="color: #888; margin-left:10px;"></small>
                    
                    <small style="color: #c55; margin-left: 10px;">
                        <i class="fas fa-clock"></i> <!-- Font Awesomeの時計アイコン (後で導入) -->
                        <span class="countdown" th:data-created-at="${log.createdAt}"></span>
                    </small>
                </div>
                
                <!-- ログのタイトルと本文へのリンク -->
                <a th:href="@{/logs/{id}(id=${log.id})}" style="text-decoration: none; color: inherit;">
                    <h3 th:text="${log.title}" style="margin: 10px 0 5px 0;">ログのタイトル</h3>
                    <p th:text="${#strings.abbreviate(log.content, 100)}" style="margin: 0 0 10px 0;">ログの本文の抜粋...</p>
                </a>

                <!-- 画像一覧 -->
                <div th:if="${not #lists.isEmpty(log.images)}" style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <div th:each="image : ${log.images}">
                        <img th:src="${image.imageUrl}" alt="ログの画像" style="max-width: 80px; max-height: 80px; object-fit: cover; border-radius: 4px;">
                    </div>
                </div>
            </li>
        </ul>

        <!-- ページネーションUI -->
        <div th:if="${logPage.totalPages > 1}" style="margin-top: 20px;">
            <nav>
                <ul style="display: flex; list-style: none; padding: 0; gap: 10px;">
                    <!-- 前へ -->
                    <li th:if="${logPage.hasPrevious()}">
                        <a th:href="@{/timeline(page=${logPage.number - 1}, size=${logPage.size})}">前へ</a>
                    </li>

                    <!-- ページ番号 -->
                    <li th:each="i : ${#numbers.sequence(0, logPage.totalPages - 1)}">
                        <a th:href="@{/timeline(page=${i}, size=${logPage.size})}"
                           th:text="${i + 1}"
                           th:style="${i == logPage.number} ? 'font-weight: bold;'"></a>
                    </li>

                    <!-- 次へ -->
                    <li th:if="${logPage.hasNext()}">
                        <a th:href="@{/timeline(page=${logPage.number + 1}, size=${logPage.size})}">次へ</a>
                    </li>
                </ul>
            </nav>
        </div>

    </div>
    <script>
        // 残り時間を更新する関数
        function updateCountdowns() {
            // "countdown"クラスを持つすべての要素を取得
            const countdownElements = document.querySelectorAll('.countdown');

            countdownElements.forEach(element => {
                // data-created-at属性から投稿日時を取得
                const createdAt = new Date(element.dataset.createdAt);
                
                // 投稿から7日後の日時を計算
                const expiryDate = new Date(createdAt.getTime());
                expiryDate.setDate(createdAt.getDate() + 7);

                // 現在時刻との差を計算 (ミリ秒)
                const now = new Date();
                const diff = expiryDate.getTime() - now.getTime();

                if (diff <= 0) {
                    element.textContent = 'このログはタイムラインから消えました';
                } else {
                    // ミリ秒を日、時間、分、秒に変換
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    // const seconds = Math.floor((diff % (1000 * 60)) / 1000); // 秒単位まで表示する場合

                    // 表示用の文字列を組み立てる
                    let remainingText = 'あと ';
                    if (days > 0) {
                        remainingText += `${days}日 `;
                    }
                    if (hours > 0 || days > 0) {
                        remainingText += `${hours}時間 `;
                    }
                    remainingText += `${minutes}分で消えます`;

                    // 要素のテキストを更新
                    element.textContent = remainingText;
                }
            });
        }

        // ページが読み込まれたら、すぐに一度実行
        updateCountdowns();
        // その後、1分ごとに繰り返し実行
        setInterval(updateCountdowns, 60000); // 60000ミリ秒 = 1分

    </script>
</body>
</html>